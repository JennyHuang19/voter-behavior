---
title: "Your project title"
author: "Approximately Normal: Jenny Huang, Bella Larsen, Jessie Bierschenk, Aidan Gildea"
date: "28 October 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```

```{r load-packages, message=FALSE}
library(tidyverse)
library(broom)
library(patchwork)
library(RColorBrewer)
library(ggthemes)
library(viridis)
```

```{r data}
elections <- read_csv("data/data_full.csv")
```

```{r data cleaning}
elections_clean <- elections %>% 
  mutate(metro = if_else(METRO == 2, "Metro", "Not Metro/Unknown")) %>% 
  mutate(sex = case_when(SEX == 1 ~ "Male",
                         SEX == 2 ~ "Female")) %>% 
  mutate(marst = case_when(MARST == 1 ~ "Married",
                           MARST == 2 ~ "Married",
                           MARST == 4 ~ "Divorced/Separated",
                           MARST == 3 ~ "Divorced/Separated",
                           TRUE ~ "Not Married/Other")) %>% 
  mutate(veteran = if_else(VETSTAT == 2, "Yes", "No/Uknnown")) %>% 
  mutate(citizen = case_when(CITIZEN == 5 | CITIZEN == 9 ~ "No/Unknown", 
                             CITIZEN == 1 | CITIZEN == 2 | CITIZEN == 3 ~ 
                               "Native Born",
                             CITIZEN == 4 ~ "Naturalized")) %>% 
  #We should probably exclude people who are not citizens from our analysis 
  #because they are not able to vote
  mutate(hispanic_status = if_else(HISPAN == 0 | HISPAN == 901 | HISPAN == 902, 
                             "Not Hispanic/Unknown", "Hispanic/Latinx")) %>% 
  mutate(employed = if_else(LABFORCE == 2, "Yes", "No/Unknown")) %>% 
  mutate(highest_education = case_when(EDUC99 == 0 | EDUC99 == 1 ~ 
                                         "None/Unknown",
                               EDUC99 == 4 | EDUC99 == 5 | EDUC99 == 6 |
                                 EDUC99 == 7 | EDUC99 == 8 | EDUC99 == 9
                               ~ "Some High School",
                               EDUC99 == 10 ~ "High School Degree/GED",
                               EDUC99 == 11 ~ "Some College",
                               EDUC99 == 12 | EDUC99 == 13 | EDUC99 == 14
                               ~ "Associate Degree",
                               EDUC99 == 15 ~ "Bachelors Degree",
                               EDUC99 == 16 ~ "Masters Degree",
                               EDUC99 == 17 ~ "Professional Degree",
                               EDUC99 == 18 ~ "Doctorate Degree")) %>% 
  mutate(current_student = case_when(SCHLCOLL == 5 | SCHLCOLL == 0 ~ 
                                       "Not currently enrolled",
                                     SCHLCOLL == 1  ~ "High School Full Time",
                                     SCHLCOLL == 2 ~ "High School Part Time",
                                     SCHLCOLL == 3 ~ "College Full Time",
                                     SCHLCOLL == 4 ~ "College Part Time")) %>% 
#of people 16-24
  mutate(race = case_when(RACE == 820 | RACE == 830 | RACE == 830 | RACE == 819 
                          | RACE == 804 | RACE == 805 | RACE == 806 | 
                            RACE == 807 | RACE == 808 | RACE == 810 | 
                            RACE == 811 | RACE == 812 | RACE == 813 | 
                            RACE == 814 | RACE == 815 | RACE == 816 | 
                            RACE == 817 | RACE == 818 | RACE == 803 | 
                            RACE == 801 | RACE == 802 | RACE == 830 ~ 
                            "2 or more races",
                          RACE == 100 ~ "White",
                          RACE == 200 ~ "Black",
                          RACE == 651 | RACE == 809 | RACE == 652 | RACE == 650
                          ~ "Asian or Pacific Islander",
                          RACE ==  300 ~ "Native American",
                          RACE == 999 | RACE == 700 ~ "Other/Unknown")) %>% 
  #Need to go over these race categorizations as a group!
  mutate(why_not_vote = case_when(VOWHYNOT == 10 ~ "Inconvenience",
                                  VOWHYNOT == 4 ~ "Interest",
                                  VOWHYNOT == 7 ~ "Political",
                                  VOWHYNOT == 9 | VOWHYNOT ==  6 | 
                                    VOWHYNOT == 5 | VOWHYNOT == 2 ~ 
                                    "Logistical",
                                  VOWHYNOT == 1 ~ "Physically Unable",
                                  VOWHYNOT == 8 ~ "Registration Issues",
                                  VOWHYNOT == 3 ~ "Forgot")) %>% 
#Reason why eligible voter did not vote
  mutate(why_not_reg = case_when(VOYNOTREG == 8 | VOYNOTREG == 3 ~ 
                                   "Not Eligible",
                                 VOYNOTREG == 7 | VOYNOTREG == 6 ~ 
                                   "Not Interested/Vote Won't Matter",
                                 VOYNOTREG == 5 ~ "Language Barrier",
                                 VOYNOTREG == 4 ~ "Physically Unable",
                                 VOYNOTREG == 2 | VOYNOTREG == 1 ~ 
                                   "Lacked Info/Missed Deadline")) %>% 
  mutate(voting_method = case_when(VOTEHOW == 1 ~ "In Person",
                                   VOTEHOW == 2 ~ "Mail-In")) %>% 
  mutate(voting_time = case_when(VOTEWHEN == 2 ~ "Early",
                                 VOTEWHEN == 1 ~"Voting Day")) %>% 
  mutate(voted = case_when(VOTED == 1 ~ 0,
                           VOTED == 2 ~ 1)) %>% 
  mutate(registered = case_when(VOREG == 1 ~ 0,
                           VOREG == 2 ~ 1)) %>% 
  mutate(how_registered = case_when(VOREGHOW == 8 ~ "Online",
                                    VOREGHOW == 7 ~ "Polling Place",
                                    VOREGHOW == 6 ~ "Registration Drive",
                                    VOREGHOW == 5 | VOREGHOW == 2 | 
                                      VOREGHOW == 1 ~ 
                                      "Govt Office/Public Agency",
                                    VOREGHOW == 4 ~ "School/College/Hospital",
                                    VOREGHOW == 3 ~ "By Mail")) %>% 
  select(metro, sex, marst, veteran, citizen, hispanic_status, employed, 
         highest_education, current_student, race, why_not_vote, why_not_reg,
         voting_method, voting_time, voted, registered, how_registered, YEAR,
         STATEFIP, AGE)

elections_clean <- elections_clean %>% 
  mutate(metro = factor(metro),
         sex = factor (sex),
         marst = factor(marst),
         veteran = factor(veteran),
         citizen = factor(citizen),
         hispanic_status = factor( hispanic_status),
         employed = factor(employed),
         highest_education = factor(highest_education),
         current_student = factor(current_student),
         race = factor(race),
         why_not_vote = factor(why_not_vote),
         why_not_reg = factor(why_not_reg),
         voting_method = factor(voting_method),
         voting_time = factor(voting_time),
         voted = factor(voted),
         registered = factor(registered),
         how_registered = factor(how_registered))

```

```{r relevel-factors}
##factor relevel to make raceWhite or raceBlack the baseline.

elections_clean <- elections_clean %>% 
  mutate(metro = factor(metro),
         sex = factor (sex),
         marst = factor(marst),
         veteran = factor(veteran),
         citizen = factor(citizen),
         hispanic_status = factor( hispanic_status),
         employed = factor(employed),
         highest_education = factor(highest_education),
         current_student = factor(current_student),
         race = factor(race),
         why_not_vote = factor(why_not_vote),
         why_not_reg = factor(why_not_reg),
         voting_method = factor(voting_method),
         voting_time = factor(voting_time),
         voted = factor(voted),
         registered = factor(registered),
         how_registered = factor(how_registered))

```

### Introduction

We will begin our EDA by visualizing the relationship between the response variable
`voted` and several of the other variables of particular interest.

We will begin by simply looking at the distribution of those who voted throughout 
the last 8 years of elections.

```{r EDA}
response_plot <- ggplot(data = elections_clean, aes(x = voted, fill = "gainsboro")) +
  geom_bar() +
  theme_bw() +
  # see theme code inspiration at reference 1 
  theme(plot.title= element_text(face="bold", color = "Navy Blue"),
        plot.subtitle = element_text(face = 4, color = "grey54"),
        panel.grid.major = element_line(color = "Navy Blue", size=.1),
        legend.position = "none") +
  # see scale fill code inspiration at reference 2
  scale_fill_manual(values = c("gainsboro")) +
  labs(title = "Visualizing the Distribution of Voting Status", y = "Count",
       x = "Voted", subtitle = "More people reportedly voted than did not vote",
       caption = "0 = Did not Vote, 1 = Voted")
response_plot
```

From the barplot above, it is clear the more individuals in the data set voted (voted = 1) than did not (voted = 0).

As college students ourselves, we want to analyze whether or not being a student influences the frequency of voting. We will explore this preliminarily by visualizing the distribution of if school aged individuals (18-24) voted or not -- categorized by their current student level. This is seen in the bar plot below.

```{r}
EDA1 <- elections_clean %>% 
  ggplot(aes(x = voted, fill = current_student)) +
  geom_bar() +
  theme_bw() +
  theme(plot.title= element_text(face="bold", color = "Navy Blue"),
        plot.subtitle = element_text(face = 4, color = "grey54"),
        panel.grid.major = element_line(color = "Navy Blue", size=.1))+
  #see scale fill brewer code inspiration from reference 1
  scale_fill_brewer(palette = "Blues") +
  labs(title = "Voting Distribution of Population of 16-24 Year Olds", 
       y = "Count", x = "Voted", 
       subtitle = "Examining relationship between student status and voting",
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Current Student Status")
EDA1
```

From the bar plot, it is evident that a majority of these individuals were not currently enrolled. This may be a result of a general national trend, but we want to investigate if it is the result of a larger proportion of older individuals within in the range of ages between 16-24. We will investigate this by analyzing those who are not currently enrolled in school within this age range.

```{r}
elections_clean %>%
  filter(current_student == "Not currently enrolled") %>%
  filter(AGE >=16 & AGE <=24) %>%
  group_by(AGE) %>%
  count()  %>% 
  ungroup() %>%
  mutate(prop = n/sum(n)) %>%
  kable(digits = 3)
```
From the kable above, it is apparent that more than 40% of those not currently enrolled in school are 23-24 years old. This could be a potential reason for why this age range includes so many who are not currently enrolled as a student. 

To more meaningfully analyze the relationship between being a student and if they vote or not, we adjusted our visualization to only include those currently enrolled in some level of education. This is seen in the visualization below. 

```{r}
EDA2 <- elections_clean %>% 
  filter(current_student != "Not currently enrolled") %>% 
  ggplot(aes(x = voted, fill = current_student)) +
  geom_bar() +
  theme_bw() +
    theme(plot.title= element_text(face="bold", color = "Navy Blue"),
        plot.subtitle = element_text(face = 4, color = "grey54"),
        panel.grid.major = element_line(color = "Navy Blue", size=.1))+
  scale_fill_brewer(palette="Blues") +
  labs(title = "Voting Distribution of Population of 16-24 Year Olds 
Enrolled in School", 
       y = "Count", x = "Voted", 
       subtitle = "Examining relationship between student status and voting",
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Current Student Status")
EDA2
```

```{r EDA3}
elections_clean %>% 
  ggplot(aes(x = voted, fill = citizen)) +
  geom_bar() +
  scale_fill_brewer(palette="Paired") +
  labs(title = "Voting distribution based on citizenship status", 
       y = "Count", x = "Voted", 
       subtitle = "Examining relationship between student status and voting",
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Citizenship Status")

```

```{r EDA4}
elections_clean %>% 
  ggplot(aes(x = AGE, y = voted)) +
  geom_boxplot() +
  coord_flip()+
  labs(title = "Relationship between age and voting", 
       y = "Voting Status", x = "Age", 
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Citizenship Status")

```

```{r EDA5}
elections_clean %>% 
  ggplot(aes(x = voted, fill = veteran)) +
  geom_bar(position = "fill") +
  scale_fill_brewer(palette="Paired") +
  labs(title = "Voting distribution based on veteran status", 
       y = "Count", x = "Voted", 
       subtitle = "Examining relationship between veteran status and voting",
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Veteran Status")

```
We are also interested in looking at how voter turnout has changed over the
years.

```{r year-voting-frequency}
elections_year <- elections_clean %>% 
  group_by(YEAR) %>% 
  count(voted) %>% 
  mutate(prop_voted = n/sum(n))
```

We notice that the proportion of people who voted fluctuates depending on
whether the year falls on a presidential election. In the trend of the 
proportion of voting over time, we see a clear divide between the years when
there is a presidential elections versus when there is not. In the future, we 
may decide to add the variable "Election Year" as an interaction term with year
as a divide between years that fall on an election.

```{r EDA6}
elections_year %>% 
  filter(voted == 1) %>% 
  ggplot(aes(x = YEAR, y = prop_voted)) +
  geom_point() +
  labs(title = "More Voters During Presidential Election Years", 
       y = "Proportion of People Who Voted", x = "Year")
```

```{r new-variable}
elections_clean <- elections_clean %>% 
  mutate(Presidential_Election_Year = if_else(YEAR %in% c(2004, 2008, 
                                                          2012, 2016), 1, 0),
         Presidential_Election_Year = factor(Presidential_Election_Year))
```

### Model Selection 

##Select a random subset of the data to create model.

```{r load-data, message = FALSE}
# add code here
set.seed(6687) #fill in last 4 digits of Duke Unique ID
elections_red <- elections_clean %>%
  sample_n(10000)
```

```{r}
int_only_model = glm(voted ~ 1,
                     data = elections_red,
                      family = "binomial")

full_model = glm(voted ~ metro + sex + marst + veteran+ citizen + 
                   hispanic_status + employed + highest_education + 
                   current_student + race + AGE + Presidential_Election_Year
                 + YEAR,
                     data = elections_red,
                      family = "binomial")

best_model <- step(full_model, scope=formula(int_only_model), direction = "backward")
tidy(best_model)
```

The final model included sex + marst + citizen + employed + highest_education + 
current_student + race + AGE + Presidential_Election_Year . 
The model took out the variables metro, veteran, and hispanic_status.

(variable: midterm after presidential election vs. not, presidential, midterm after incumbant, midterm after new pres)

### Checking Model Conditions 

```{r}
elections_red %>%
  count(sex, voted) %>%
  group_by(sex) %>%
  mutate(prop = n/sum(n)) %>%
  filter(voted == "1") %>%
  mutate(emp_logit = log(prop/(1-prop)))

elections_red %>%
  count(marst, voted) %>%
  group_by(marst) %>%
  mutate(prop = n/sum(n)) %>%
  filter(voted == "1") %>%
  mutate(emp_logit = log(prop/(1-prop)))
```

According to the plot below, there is a linear relationship between the
empirical logit and the predictor variable age. Hence linearity is satisfied 
for AGE.

```{r}
library(Stat2Data)
emplogitplot1(voted ~ AGE, data = elections_red, 
              ngroups = 10)
```

Randomness: It is possible that randomness is not satisfied because our data is
from the census survey, which may not be random (ie might select for people who
have time to fill it out).

Independence: Independence may be violated because geographic location may
influence voting due to factors such as (residuals by state ID). Hence, we will
look at misclassification rate by region.

```{r}
library(maps)
data(state.fips)
joined_fips <- left_join(elections_red, state.fips, by = c("STATEFIP" = "fips"))
```

```{r}
model_aug <- augment(best_model, type.predict = "response") #probability
```

Here, we create a confusion matrix with a misclassification rate of 0.5.
```{r}
model_aug <- model_aug %>% 
  mutate(predicted_voted = if_else(.fitted > 0.5, "Will Vote", "Will Not Vote"))
```

We will left join with region to look at misclassification rates by region.
```{r}
tojoin <- joined_fips %>% 
  select(AGE, region)

aug_fips <- left_join(model_aug, tojoin, by ="AGE")
```

Below are the misclassification rates by region.
```{r}
aug_fips <- aug_fips %>% 
  mutate(region = case_when(region == 1 ~ "Northeast",
                            region == 2 ~ "Midwest",
                            region == 3 ~ "South",
                            region == 4 ~ "West"))
# used Census data for the region fips number corresponding to region name [3]

aug_fips %>% 
  group_by(region) %>% 
  count(voted, predicted_voted) %>%  #all combs of responses specified as arguments
  mutate(prop = n / sum(n)) %>% 
  filter(voted == 1 & predicted_voted == "Will Not Vote" | 
        voted == 0 & predicted_voted == "Will Vote") 
```
We plan to create a plot of misclassification rate by region to determine if 
independence is satisfied.

```{r}
aug_fips %>% 
  group_by(region) %>% 
  count(voted, predicted_voted) %>%  #all combs of responses specified as arguments
  ggplot(., aes(x = predicted_voted, y = n, color = region)) +
  geom_boxplot()
```




##Checking for influential points

```{r}
best_aug <- augment(best_model) %>%
   mutate(obs_num = row_number()) #add row number to help with graphing
```

## Cook's distance
We will also look for influential points using Cook's D.

```{r}
## scatterplot of Cook's D vs. observation number
ggplot(data = best_aug, aes(x = obs_num, y = .cooksd)) +
  geom_point(alpha = 0.7) +
  geom_hline(yintercept = c(0.5,1), color = "red", lty = 2) +
  labs(x = "Observation Number", y = "Cook's D") +
  geom_text(aes(label = ifelse(.hat > 0.5,
                           as.character(obs_num), "")), nudge_x = 1)
```
According to Cook's D, there are no influential points, 
so all points can be left in the model.

Below, we check for multicolinearity.

```{r}
# load rms package and calculate VIF
library(rms)
vif(best_model) %>% 
  tidy() %>% 
  arrange(x)
```

We observe that raceWhite has a VIF value
that is above 10 (10.072951). This means that colinearity might be present
between raceWhite and raceBlack (7.074850).




[1] http://www.sthda.com/english/articles/32-r-graphics-essentials/125-ggplot-cheat-sheet-for-great-customization/#use-themes-in-ggplot2-package
[2] https://www.datanovia.com/en/blog/the-a-z-of-rcolorbrewer-palette/
[3] https://www2.census.gov/geo/pdfs/maps-data/maps/reference/us_regdiv.pdf

keep in mind: citizenship and registration exclusion for the model